const repo = import.meta.env.PUBLIC_GISCUS_REPO;
const repoId = import.meta.env.PUBLIC_GISCUS_REPO_ID;
const category = import.meta.env.PUBLIC_GISCUS_CATEGORY;
const categoryId = import.meta.env.PUBLIC_GISCUS_CATEGORY_ID;

const isGiscusConfigured = repo && repoId && category && categoryId;

function getCurrentLanguage(): 'zh' | 'en' {
  const pathname = Astro.url.pathname;
  if (pathname.startsWith('/zh/')) return 'zh';
  if (pathname.startsWith('/en/')) return 'en';
  return 'en';
}

const currentLang = getCurrentLanguage();

const giscusLangMap = {
  'zh': 'zh-CN',
  'en': 'en'
};

const giscusLang = giscusLangMap[currentLang];
---

{isGiscusConfigured && (
  <div id="giscus-container" class="giscus mt-8 pt-8 border-t border-gray-200 dark:border-gray-700">
    <style is:global>
      .giscus, .giscus-frame {
        width: 100%;
      }
    </style>
    <script
      src="https://giscus.app/client.js"
      data-repo={repo}
      data-repo-id={repoId}
      data-category={category}
      data-category-id={categoryId}
      data-mapping="pathname"
      data-strict="0"
      data-reactions-enabled="1"
      data-emit-metadata="1"
      data-input-position="top"
      data-theme="https://pxwg-dogggie.github.io/blog/giscus-theme.css"
      data-lang={giscusLang}
      data-loading="lazy"
      crossorigin="anonymous"
      async
    >
    </script>
  </div>
)}

{!isGiscusConfigured && (
  <div class="mt-8 pt-8 border-t border-gray-200 dark:border-gray-700 text-center text-gray-500">
    <p>
      {currentLang === 'zh'
        ? '评论功能暂未配置。如需启用评论，请配置 Giscus 环境变量。'
        : 'Comment feature is not configured. Please configure Giscus environment variables to enable comments.'
      }
    </p>
  </div>
)}

{isGiscusConfigured && (
  <script is:inline>
    function setGiscusTheme(theme) {
      const giscusFrame = document.querySelector('iframe.giscus-frame');
      if (giscusFrame) {
        giscusFrame.contentWindow.postMessage(
          { giscus: { setConfig: { theme: theme } } },
          'https://giscus.app'
        );
      }
    }

    const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
    const themeMap = {
      light: 'https://pxwg-dogggie.github.io/blog/giscus-theme.css',
      dark: 'https://pxwg-dogggie.github.io/blog/giscus-theme.css',
    };

    setTimeout(() => {
      setGiscusTheme(themeMap[currentTheme]);
    }, 1000);

    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.attributeName === 'class') {
          const newTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
          setGiscusTheme(themeMap[newTheme]);
        }
      });
    });

    observer.observe(document.documentElement, {
      attributes: true,
    });
  </script>
)}
