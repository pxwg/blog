---
interface Props {
  articleId?: string;
}

const { articleId } = Astro.props;

// Helper function to get language toggle links
function getLanguageLinks(currentUrl: string, articleId?: string) {
  const url = new URL(currentUrl);
  const pathname = url.pathname;
  
  // Determine current language from URL or article content
  let currentLang = 'zh'; // default to Chinese
  let basePath = pathname;
  
  if (pathname.includes('/en/') || pathname.includes('_en')) {
    currentLang = 'en';
    basePath = pathname.replace(/\/en\//, '/').replace(/_en/, '');
  } else if (pathname.includes('/zh/') || pathname.includes('_zh')) {
    currentLang = 'zh'; 
    basePath = pathname.replace(/\/zh\//, '/').replace(/_zh/, '');
  }
  
  // For article pages, construct relative paths for different languages
  if (articleId) {
    // Clean up the pathname to get the base article path
    // Remove any language segments and duplicate article IDs
    let cleanPath = pathname;
    
    // Remove language segments like /en/ or /zh/
    cleanPath = cleanPath.replace(/\/(zh|en)\//g, '/');
    
    // For paths like /article/float_and_pin/en/float_and_pin, extract the base article
    const articleMatch = cleanPath.match(/\/article\/([^\/]+)/);
    const baseArticle = articleMatch ? articleMatch[1] : articleId;
    
    const zhLink = currentLang === 'en' ? 
      `/article/${baseArticle}/` : 
      `/article/${baseArticle}/zh/${baseArticle}/`;
    const enLink = currentLang === 'zh' ? 
      `/article/${baseArticle}/en/${baseArticle}/` : 
      `/article/${baseArticle}/`;
      
    return {
      zh: zhLink,
      en: enLink,
      current: currentLang
    };
  }
  
  // For other pages, construct language-specific relative URLs
  const zhLink = currentLang === 'en' ? 
    basePath.replace('/en/', '/zh/') : 
    basePath.includes('/zh/') ? basePath : basePath + '/zh/';
  const enLink = currentLang === 'zh' ? 
    basePath.replace('/zh/', '/en/') : 
    basePath.includes('/en/') ? basePath : basePath + '/en/';
  
  return {
    zh: zhLink,
    en: enLink,
    current: currentLang
  };
}

const links = getLanguageLinks(Astro.url.href, articleId);
---

<div class="language-toggle">
  <a 
    href={links.zh} 
    class:list={["lang-link", { active: links.current === 'zh' }]}
    title="切换到中文"
    aria-label="Switch to Chinese"
  >
    中文
  </a>
  <span class="separator" aria-hidden="true">|</span>
  <a 
    href={links.en} 
    class:list={["lang-link", { active: links.current === 'en' }]}
    title="Switch to English"
    aria-label="Switch to English"
  >
    EN
  </a>
</div>

<style>
  .language-toggle {
    display: flex;
    align-items: center;
    gap: 0.5em;
    font-size: 0.9em;
  }
  
  .lang-link {
    color: var(--gray-color);
    text-decoration: none;
    padding: 0.25em 0.5em;
    border-radius: 3px;
    transition: color 0.2s, background-color 0.2s, border-bottom 0.2s;
    font-weight: 500;
    border-bottom: 2px solid transparent;
  }
  
  .lang-link:hover {
    color: var(--main-hover-color);
    background-color: var(--accent-bg-color, rgba(128, 128, 128, 0.1));
    border-bottom-color: var(--main-hover-color);
  }
  
  .lang-link.active {
    color: var(--accent);
    font-weight: 600;
    background-color: var(--accent-bg-color, rgba(207, 130, 158, 0.15));
    border-bottom-color: var(--accent);
  }
  
  .separator {
    color: var(--gray-color);
    opacity: 0.5;
    font-weight: 300;
  }
  
  @media (max-width: 680px) {
    .language-toggle {
      font-size: 0.8em;
      gap: 0.4em;
    }
    
    .lang-link {
      padding: 0.2em 0.4em;
    }
  }
  
  @media (max-width: 400px) {
    .language-toggle {
      font-size: 0.75em;
    }
  }
</style>
