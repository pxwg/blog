---
import fs from 'fs';
import path from 'path';

interface Props {
  articleId?: string;
}

const { articleId } = Astro.props;

// Helper function to get language toggle links
function getLanguageLinks(currentUrl: string, articleId?: string) {
  const url = new URL(currentUrl);
  const pathname = url.pathname;

  // Check if we're on an article page
  const articleMatch = pathname.match(/^\/blog\/article\/(.+?)\/?$/);
  
  if (!articleMatch) {
    // Not on an article page, return default homepage links
    return {
      zh: '/blog/',
      en: '/blog/',
      current: 'zh' as const
    };
  }
  
  const articlePath = articleMatch[1];
  let currentLang: 'zh' | 'en' = 'zh';
  let baseArticle = articlePath;
  
  // Determine current language and base article from URL
  if (articlePath.startsWith('en/')) {
    currentLang = 'en';
    baseArticle = articlePath.replace(/^en\//, '');
  } else if (articlePath.startsWith('zh/')) {
    currentLang = 'zh';
    baseArticle = articlePath.replace(/^zh\//, '');
  } else {
    // No language prefix, determine from file existence
    const projectRoot = process.cwd();
    const baseFile = `${articlePath}.typ`;
    const zhPath = path.join(projectRoot, 'content/article/zh', baseFile);
    const enPath = path.join(projectRoot, 'content/article/en', baseFile);
    
    const zhExists = fs.existsSync(zhPath);
    const enExists = fs.existsSync(enPath);
    
    if (zhExists && enExists) {
      // Both translations exist, current is the root version (default to zh)
      currentLang = 'zh';
    } else if (zhExists) {
      // Only Chinese translation exists, current must be English root
      currentLang = 'en';
    } else if (enExists) {
      // Only English translation exists, current must be Chinese root  
      currentLang = 'zh';
    }
    // If neither exists, stay with default 'zh'
  }
  
  // Generate toggle links based on the pattern specified
  let zhLink, enLink;
  
  if (currentLang === 'zh') {
    // Currently on Chinese, switch to English
    if (articlePath.startsWith('zh/')) {
      // /blog/article/zh/xxx/ -> /blog/article/xxx/
      zhLink = `/blog/article/${articlePath}/`;
      enLink = `/blog/article/${baseArticle}/`;
    } else {
      // /blog/article/xxx/ -> /blog/article/en/xxx/ (if translation exists)
      zhLink = `/blog/article/${articlePath}/`;
      
      const projectRoot = process.cwd();
      const enPath = path.join(projectRoot, 'content/article/en', `${baseArticle}.typ`);
      const enExists = fs.existsSync(enPath);
      
      enLink = enExists ? `/blog/article/en/${baseArticle}/` : `/blog/article/${articlePath}/`;
    }
  } else {
    // Currently on English, switch to Chinese
    if (articlePath.startsWith('en/')) {
      // /blog/article/en/xxx/ -> /blog/article/xxx/
      enLink = `/blog/article/${articlePath}/`;
      zhLink = `/blog/article/${baseArticle}/`;
    } else {
      // /blog/article/xxx/ -> /blog/article/zh/xxx/ (if translation exists)
      enLink = `/blog/article/${articlePath}/`;
      
      const projectRoot = process.cwd();
      const zhPath = path.join(projectRoot, 'content/article/zh', `${baseArticle}.typ`);
      const zhExists = fs.existsSync(zhPath);
      
      zhLink = zhExists ? `/blog/article/zh/${baseArticle}/` : `/blog/article/${articlePath}/`;
    }
  }

  return {
    zh: zhLink,
    en: enLink,
    current: currentLang
  };
}

const links = getLanguageLinks(Astro.url.href, articleId);
---

<div class="language-toggle">
  <a 
    href={links.zh} 
    class:list={["lang-link", { active: links.current === 'zh' }]}
    title="切换到中文"
    aria-label="Switch to Chinese"
  >
    中文
  </a>
  <span class="separator" aria-hidden="true">|</span>
  <a 
    href={links.en} 
    class:list={["lang-link", { active: links.current === 'en' }]}
    title="Switch to English"
    aria-label="Switch to English"
  >
    EN
  </a>
</div>

<style>
  .language-toggle {
    display: flex;
    align-items: center;
    gap: 0.5em;
    font-size: 0.9em;
  }
  
  .lang-link {
    color: var(--gray-color);
    text-decoration: none;
    padding: 0.25em 0.5em;
    border-radius: 3px;
    transition: color 0.2s, background-color 0.2s, border-bottom 0.2s;
    font-weight: 500;
    border-bottom: 2px solid transparent;
  }
  
  .lang-link:hover {
    color: var(--main-hover-color);
    background-color: var(--accent-bg-color, rgba(128, 128, 128, 0.1));
    border-bottom-color: var(--main-hover-color);
  }
  
  .lang-link.active {
    color: var(--accent);
    font-weight: 600;
    background-color: var(--accent-bg-color, rgba(207, 130, 158, 0.15));
    border-bottom-color: var(--accent);
  }
  
  .separator {
    color: var(--gray-color);
    opacity: 0.5;
    font-weight: 300;
  }
  
  @media (max-width: 680px) {
    .language-toggle {
      font-size: 0.8em;
      gap: 0.4em;
    }
    
    .lang-link {
      padding: 0.2em 0.4em;
    }
  }
  
  @media (max-width: 400px) {
    .language-toggle {
      font-size: 0.75em;
    }
  }
</style>
