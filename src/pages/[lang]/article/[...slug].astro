---
import { render, getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";

import BlogPost from "$layouts/BlogPost.astro";
import { getGitModifiedDate } from "../../../utils/git";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts.map((post) => {
    const [lang, ...slugParts] = post.id.split('/');
    const slug = slugParts.join('/');

    post.data.modifiedDate = getGitModifiedDate(post.id, {
      contentDir: 'content/article',
      fileExtension: '.typ',
      fallbackDate: post.data.date,
      debug: true
    });
    post.data.updatedDate = post.data.modifiedDate;

    return {
      params: { lang, slug },
      props: { post },
    };
  });
}

type Props = { post: CollectionEntry<'blog'> };
const { post } = Astro.props;
const { lang: urlLang } = Astro.params;

// Use frontmatter language as single source of truth
const { lang: postLang, translationKey } = post.data;

// Find translation using translationKey
let translationUrl: string | undefined = undefined;
if (translationKey) {
  const targetLang = postLang === 'en' ? 'zh' : 'en';
  const allPosts = await getCollection('blog');
  const translatedPost = allPosts.find(
    (p) => p.data.translationKey === translationKey && p.data.lang === targetLang
  );

  if (translatedPost) {
    translationUrl = `/${translatedPost.id.replace('/', '/article/')}/`;
  }
}

const { Content } = await render(post);
---

<BlogPost
  {...post.data}
  id={post.id}
  slug={post.slug}
  translationUrl={translationUrl}>
  <Content />
  <p><a href="../">ðŸ›« Back to all articles</a></p>
</BlogPost>
