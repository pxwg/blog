---
import { getCollection } from "astro:content";
import { execSync } from 'node:child_process'; 
import TagList from "$components/TagList.astro";
import { Search } from "@myriaddreamin/tylant";
import BaseHead from "$components/BaseHead.astro";
import Footer from "$components/Footer.astro";
import FormattedDate from "$components/FormattedDate.astro";
import Header from "$components/Header.astro";
import { kUrlBase, kSiteTitle, kSiteDescription, kEnableSearch } from "$consts";
import "$styles/IndexPostList.css";

interface Props {
  lang: string;
}

export async function getStaticPaths() {
  return [
    { params: { lang: "en" } },
    { params: { lang: "zh" } }
  ];
}

const { lang } = Astro.params;

const allPosts = await getCollection("blog");

const postsWithModifiedDate = allPosts.map(post => {
  const filePath = `content/article/${post.id}.typ`;
  
  try {
    console.log('Checking filePath:', filePath);
    // Get the last commit date and remove any trailing whitespace
    const lastUpdated = execSync(`git log -1 --pretty="format:%cI" -- "${filePath}"`).toString().trim();
    console.log('Git log output for', filePath, ':', lastUpdated);
    
    if (lastUpdated) {
      return {
        ...post,
        data: {
          ...post.data,
          modifiedDate: new Date(lastUpdated),
          debug: { filePath, lastUpdated, success: true }
        }
      };
    }
  } catch (e) {
    console.log('Error for', filePath, ':', e.message);
  }
  
  // If git log fails or returns empty, use the pubDate as fallback
  return {
    ...post,
    data: {
      ...post.data,
      modifiedDate: post.data.date,
      debug: { filePath, lastUpdated: null, success: false, fallback: true }
    }
  };
});

const sortedPosts = postsWithModifiedDate.sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
);

const posts = sortedPosts.filter(post => post.id.startsWith(`${lang}/`));

// Language-specific configurations
const languageConfig = {
  en: {
    htmlLang: "en",
    title: "All Posts",
    tagListLang: undefined
  },
  zh: {
    htmlLang: "zh",
    title: "全部文章",
    tagListLang: "zh"
  }
};

const config = languageConfig[lang as keyof typeof languageConfig] || languageConfig.en;
---

<!doctype html>
<html lang={config.htmlLang}>
  <head>
    <BaseHead title={kSiteTitle} description={kSiteDescription} />
    <style>
      .posts.loading { display: none; }
      main.search-enabled { padding-top: 0; }
      @media (max-width: 600px) { .heading { display: flex; flex-direction: column; } }
    </style>
  </head>
  <body>
    <Header />
    {kEnableSearch && <Search />}
    <main class={kEnableSearch ? "search-enabled" : ""}>
      <section>
        <h2 style="margin-bottom: 1rem; font-size: 2rem;">
          {config.title}
        </h2>
        <ul class={`accent block-list posts${kEnableSearch ? " loading" : ""}`}>
          {
            posts.map((post) => {
              const postUrl = `${kUrlBase}/${lang}/article/${post.id.replace(`${lang}/`, '')}/`;
              return (
                <li
                  data-article-id={post.id}
                  data-article-meta={JSON.stringify({
                    title: post.data.title,
                    description: post.data.description,
                    tags: post.data.tags,
                    date: post.data.date.toISOString(),
                    modifiedDate: post.data.modifiedDate ? post.data.modifiedDate.toISOString() : null
                  })}
                >
                  <a class="heading" href={postUrl}>
                    <h2><span class="title">{post.data.title}</span></h2>
                    <span class="date"><FormattedDate date={post.data.date} /></span>
                  </a>
                  {post.data.tags && <TagList tags={post.data.tags} lang={config.tagListLang} />}
                  {post.data.description || ""}
                </li>
              )
            })
          }
        </ul>
        {
          kEnableSearch && (
            <script>
              document.addEventListener('DOMContentLoaded', () => {
                const postsElement = document.querySelector('.posts');
                if (postsElement) {
                  postsElement.classList.remove('loading');
                }
              });
            </script>
          )
        }
      </section>
    </main>
    <Footer />
  </body>
</html>
