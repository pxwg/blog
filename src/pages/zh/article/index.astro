---
import { getCollection } from "astro:content";
import TagList from "$components/TagList.astro";
import { Search } from "@myriaddreamin/tylant";
import BaseHead from "$components/BaseHead.astro";
import Footer from "$components/Footer.astro";
import FormattedDate from "$components/FormattedDate.astro";
import Header from "$components/Header.astro";
import { kUrlBase, kSiteTitle, kSiteDescription, kEnableSearch } from "$consts";
import "$styles/IndexPostList.css";

const allPosts = (await getCollection("blog")).sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
);

// Filter posts for Chinese language
const zhPosts = allPosts.filter(post => post.id.startsWith('zh/'));
---

<!doctype html>
<html lang="zh">
  <head>
    <BaseHead title={kSiteTitle} description={kSiteDescription} />
    <style>
      .posts.loading { display: none; }
      main.search-enabled { padding-top: 0; }
      @media (max-width: 600px) { .heading { display: flex; flex-direction: column; } }
    </style>
  </head>
  <body>
    <Header />
    {kEnableSearch && <Search />}
    <main class={kEnableSearch ? "search-enabled" : ""}>
      <section>
        <h2 style="margin-bottom: 1rem; font-size: 2rem;">
          全部文章
        </h2>
        <ul class={`accent block-list posts${kEnableSearch ? " loading" : ""}`}>
          {
            zhPosts.map((post) => {
              const postUrl = `${kUrlBase}/zh/article/${post.id.replace('zh/', '')}/`;
              return (
                <li
                  data-article-id={post.id}
                  data-article-meta={JSON.stringify({
                    title: post.data.title,
                    description: post.data.description,
                    tags: post.data.tags,
                    date: post.data.date,
                    modifiedDate: post.data.modifiedDate
                  })}
                >
                  <a class="heading" href={postUrl}>
                    <h2><span class="title">{post.data.title}</span></h2>
                    <span class="date"><FormattedDate date={post.data.date} /></span>
                  </a>
                  {post.data.tags && <TagList tags={post.data.tags} lang="zh" />}
                  {post.data.description || ""}
                </li>
              )
            })
          }
        </ul>
        {
          kEnableSearch && (
            <script>
              document.addEventListener('DOMContentLoaded', () => {
                const postsElement = document.querySelector('.posts');
                if (postsElement) {
                  postsElement.classList.remove('loading');
                }
              });
            </script>
          )
        }
      </section>
    </main>
    <Footer />
  </body>
</html>
